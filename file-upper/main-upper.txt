#INCLUDE "FILEIO.S"

.EQU BUFFER_LEN, 256

.GLOBAL _START
.ALIGN 2

_START:
    OPEN_FILE INPUT_FILE, O_RDONLY
    ; XNU PRIVATE ABI: SYSCALL ERROR IS REPORTED IN THE CARRY FLAG
    B.CC SKIP_INPUT_ERROR
    MOV X1, #1   ; STDOUT
    ADRP X2, INPUT_ERROR_SIZE@PAGE
    ADD X2, X2, INPUT_ERROR_SIZE@PAGEOFF
    LDR W2, [X2]
    WRITE_FILE X1, INPUT_ERROR_MESSAGE, X2
    MOV X0, #-1
    B EXIT

SKIP_INPUT_ERROR:
    MOV X11, X0   ; INPUT FD

    OPEN_FILE OUTPUT_FILE, O_CREAT|O_WRONLY
    ; XNU PRIVATE ABI: SYSCALL ERROR IS REPORTED IN THE CARRY FLAG
    B.CC SKIP_OUTPUT_ERROR
    MOV X1, #1   ; STDOUT
    ADRP X2, OUTPUT_ERROR_SIZE@PAGE
    ADD X2, X2, OUTPUT_ERROR_SIZE@PAGEOFF
    LDR W2, [X2]
    WRITE_FILE X1, OUTPUT_ERROR_MESSAGE, X2
    MOV X0, #-1
    B EXIT

SKIP_OUTPUT_ERROR:
    MOV X12, X0   ; OUTPUT FD

LOOP:
    READ_FILE X11, BUFFER, BUFFER_LEN
    MOV X13, X0   ; LENGTH READ

    ADRP X0, BUFFER@PAGE
    ADD X0, X0, BUFFER@PAGEOFF
    MOV X1, X13
    BL TOUPPER

    WRITE_FILE X12, BUFFER, X13

    CMP X13, BUFFER_LEN
    B.EQ LOOP

    FLUSH_CLOSE X11
    FLUSH_CLOSE X12

    MOV X0, XZR

EXIT:
    MOV X16, #SYS_EXIT
    SVC #0X80

TOUPPER:
    ; CONVERT STRING TO UPPER CASE IGNORING CHARACTERS OUTSIDE OF A-Z RANGE
    ; X0 - POINTER TO STRING
    ; X1 â€“ STRING LENGTH
    ;
    ; X2 IS AN INDEX, X3 IS A CURRENT BYTE
    EOR X2, X2, X2
    UPPER_LOOP:
        LDRB W3, [X0, X2]
        CMP W3, 'A'
        B.CC SKIP
        CMP W3, '{'
        B.CS SKIP
        SUB W3, W3, #('A' - 'A')
        STRB W3, [X0, X2]
        SKIP:
        ADD X2, X2, #1
        CMP X2, X1
        B.NE UPPER_LOOP
    RET


INPUT_FILE: .ASCIZ "MAIN.S"
OUTPUT_FILE: .ASCIZ "MAIN-UPPER.TXT"
INPUT_ERROR_MESSAGE: .ASCIZ "FAILED TO OPEN INPUT FILE\N"
INPUT_ERROR_SIZE: .WORD  .-INPUT_ERROR_MESSAGE
OUTPUT_ERROR_MESSAGE: .ASCIZ "FAILED TO OPEN OUTPUT FILE\N"
OUTPUT_ERROR_SIZE: .WORD  .-OUTPUT_ERROR_MESSAGE

.DATA
BUFFER: .FILL  BUFFER_LEN + 1, 1, 0
